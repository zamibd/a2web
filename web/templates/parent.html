{{define "content"}}
<div class="flex flex-col items-center justify-center min-h-screen">
    <h1 class="text-3xl font-bold mb-4">Monitoring Session</h1>
    <div class="card w-96 bg-base-100 shadow-xl">
        <div class="card-body items-center text-center">
            <h2 class="card-title">Live Feed</h2>
            <p>Audio should play automatically when stream is active.</p>
            <audio id="audioPlayer" controls class="mt-4"></audio>
            <div id="status" class="mt-4 badge badge-ghost">Connecting...</div>
        </div>
    </div>
    <a href="/dashboard" class="btn btn-ghost mt-8">Back to Dashboard</a>
</div>

<script>
    const sessionID = "{{.SessionID}}";
    const statusDiv = document.getElementById('status');
    const audioPlayer = document.getElementById('audioPlayer');

    // MediaSource Approach for low latency streaming
    const mediaSource = new MediaSource();
    audioPlayer.src = URL.createObjectURL(mediaSource);

    let sourceBuffer;
    let queue = [];

    mediaSource.addEventListener('sourceopen', () => {
        // Need to know codec. usually audio/webm; codecs=opus
        sourceBuffer = mediaSource.addSourceBuffer('audio/webm; codecs=opus');
        sourceBuffer.mode = 'sequence';

        sourceBuffer.addEventListener('updateend', () => {
            if (queue.length > 0 && !sourceBuffer.updating) {
                sourceBuffer.appendBuffer(queue.shift());
            }
        });

        connectWS();
    });

    function connectWS() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/ws/parent/${sessionID}`);

        ws.binaryType = 'arraybuffer'; // Critical for handling binary audio data

        ws.onopen = () => {
            statusDiv.innerText = "Connected & Listening";
            statusDiv.classList.add("badge-success");
        };

        ws.onmessage = async (event) => {
            const data = event.data;
            if (sourceBuffer && !sourceBuffer.updating) {
                try {
                    sourceBuffer.appendBuffer(data);
                } catch (e) {
                    console.error(e);
                }
            } else {
                queue.push(data);
            }

            // Ensure playing
            if (audioPlayer.paused) {
                audioPlayer.play().catch(e => console.log("Autoplay blocked:", e));
            }
        };

        ws.onclose = () => {
            statusDiv.innerText = "Disconnected";
            statusDiv.classList.remove("badge-success");
            statusDiv.classList.add("badge-error");
        };
    }
</script>
{{end}}