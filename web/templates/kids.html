{{define "content"}}
<div class="flex flex-col items-center justify-center min-h-screen">
    <h1 class="text-3xl font-bold mb-4">Session: {{.SessionName}}</h1>
    <div class="card w-96 bg-base-100 shadow-xl">
        <div class="card-body items-center text-center">
            <h2 class="card-title">Live Audio Stream</h2>
            <p>Initializing audio stream...</p>
            <div id="status" class="mt-4 badge badge-ghost text-lg p-4">Requesting Permission...</div>
        </div>
    </div>
</div>

<script>
    let mediaRecorder;
    let ws;
    const sessionID = "{{.SessionID}}";
    const statusDiv = document.getElementById('status');
    // Auto-start on load
    window.addEventListener('load', startStream);

    async function startStream() {
        try {
            statusDiv.innerText = "Requesting Microphone...";
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

            // Connect WS
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/kid/${sessionID}`);

            ws.onopen = () => {
                statusDiv.innerText = "ðŸ”´ Live & Streaming";
                statusDiv.classList.remove("badge-ghost", "badge-error");
                statusDiv.classList.add("badge-success", "animate-pulse");

                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && ws.readyState === WebSocket.OPEN) {
                        ws.send(event.data);
                    }
                };

                mediaRecorder.start(300); // 300ms chunks
            };

            ws.onclose = () => {
                statusDiv.innerText = "Disconnected";
                statusDiv.classList.remove("badge-success", "animate-pulse");
                statusDiv.classList.add("badge-error");
            };

            ws.onerror = (err) => {
                console.error("WS Error", err);
                statusDiv.innerText = "Connection Error";
                statusDiv.classList.add("badge-error");
            }

        } catch (err) {
            console.error(err);
            statusDiv.innerText = "Microphone Denied / Error";
            statusDiv.classList.remove("badge-ghost");
            statusDiv.classList.add("badge-error");
            alert("Microphone access is required. Please allow access and refresh.");
        }
    }
</script>
{{end}}