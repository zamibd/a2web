{{define "content"}}
<div class="flex flex-col items-center justify-center min-h-screen">
    <h1 class="text-3xl font-bold mb-4">Session: {{.SessionName}}</h1>
    <div class="card w-96 bg-base-100 shadow-xl">
        <div class="card-body items-center text-center">
            <h2 class="card-title">Live Audio Stream</h2>
            <p>Click START to broadcast your microphone.</p>
            <div class="card-actions justify-end mt-4">
                <button id="startBtn" class="btn btn-primary btn-lg">START STREAM</button>
                <button id="stopBtn" class="btn btn-error btn-lg hidden">STOP</button>
            </div>
            <div id="status" class="mt-4 badge badge-ghost">Ready</div>
        </div>
    </div>
</div>

<script>
    let mediaRecorder;
    let ws;
    const sessionID = "{{.SessionID}}";
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusDiv = document.getElementById('status');

    startBtn.onclick = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

            // Connect WS
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/kid/${sessionID}`);

            ws.onopen = () => {
                statusDiv.innerText = "Connected & Streaming";
                statusDiv.classList.add("badge-success");

                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && ws.readyState === WebSocket.OPEN) {
                        ws.send(event.data);
                    }
                };

                mediaRecorder.start(300); // 300ms chunks

                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
            };

            ws.onclose = () => {
                statusDiv.innerText = "Disconnected";
                statusDiv.classList.remove("badge-success");
                statusDiv.classList.add("badge-error");
                stopStream();
            };

        } catch (err) {
            console.error(err);
            alert("Microphone access denied or error: " + err);
        }
    };

    stopBtn.onclick = stopStream;

    function stopStream() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        if (ws) {
            ws.close();
        }
        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
        statusDiv.innerText = "Stopped";
        statusDiv.classList.remove("badge-success");
    }
</script>
{{end}}